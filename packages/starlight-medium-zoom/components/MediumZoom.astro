<starlight-medium-zoom>
  <template id="starlight-medium-zoom-template">
    <div class="starlight-medium-zoom-content">
      <div class="starlight-medium-zoom-img"></div>
      <div class="starlight-medium-zoom-caption starlight-medium-zoom-caption-hidden"></div>
    </div>
  </template>
</starlight-medium-zoom>

<style>
  :global(.medium-zoom-overlay) {
    inset: 0;
    opacity: 0;
    position: fixed;
    transition: opacity 0.3s;
    will-change: opacity;
    z-index: 50;
  }

  :global(.medium-zoom--opened .medium-zoom-overlay) {
    cursor: zoom-out;
    opacity: 1;
  }

  :global(.medium-zoom-image) {
    cursor: zoom-in;
    transition: transform 0.3s cubic-bezier(0.2, 0, 0.2, 1);
  }

  :global(.medium-zoom-image--hidden) {
    visibility: hidden;
  }

  :global(.medium-zoom-image--opened) {
    cursor: zoom-out;
    position: relative;
    will-change: transform;
    z-index: 52;
  }

  .starlight-medium-zoom-content {
    height: 520px;
    inset: 0;
    margin: auto 2rem;
    position: fixed;
    z-index: 51;
  }

  .starlight-medium-zoom-img {
    background-color: var(--sl-color-bg);
    border: 1px solid var(--sl-color-gray-6);
    height: 100%;
  }

  .starlight-medium-zoom-caption {
    background-color: var(--sl-color-bg-sidebar);
    border: 1px solid var(--sl-color-gray-6);
    border-top: 0;
  }

  .starlight-medium-zoom-caption-hidden {
    display: none;
  }
</style>

<script>
  customElements.define(
    'starlight-medium-zoom',
    class StarlightMediumZoom extends HTMLElement {
      #caption: HTMLDivElement | null | undefined

      constructor() {
        super()

        // TODO(HiDeoo)
        const image = document.querySelector<HTMLDivElement>('.sl-markdown-content img')
        if (!image) return

        const template = document.querySelector<HTMLTemplateElement>('#starlight-medium-zoom-template')
        this.#caption = template?.content.querySelector('.starlight-medium-zoom-caption')

        window.addEventListener('DOMContentLoaded', () => {
          const onIdle = window.requestIdleCallback || ((cb) => setTimeout(cb, 1))

          onIdle(async () => {
            const { default: mediumZoom } = await import('medium-zoom/dist/pure')

            const zoom = mediumZoom('.sl-markdown-content img', {
              background: 'hsla(224 10% 10% / 0.95)',
              container: '.starlight-medium-zoom-img',
              template: '#starlight-medium-zoom-template',
            })

            zoom.on('open', this.#onOpen)
          })
        })
      }

      #setCaption(text: string) {
        if (!this.#caption) return

        text = text.trim()

        if (text.length === 0) {
          this.#caption.classList.add('starlight-medium-zoom-caption-hidden')
          return
        } else {
          this.#caption.classList.remove('starlight-medium-zoom-caption-hidden')
          this.#caption.textContent = text
        }
      }

      #onOpen = (event: Event) => {
        if (!(event.target instanceof HTMLImageElement)) return

        this.#setCaption(event.target.alt)
      }
    },
  )
</script>
